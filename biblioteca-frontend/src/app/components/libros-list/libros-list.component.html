<div class="libros-list-container">
  <h2>Nuestra Colección de Libros</h2>

  <div class="controles-superiores">
    <button *ngIf="isAdmin$ | async" (click)="toggleFormularioAgregarLibro()" class="btn btn-agregar" [disabled]="cargandoDependencias">
      {{ mostrandoFormulario ? 'Cancelar Creación' : 'Agregar Nuevo Libro' }}
      <span *ngIf="cargandoDependencias && mostrandoFormulario">(Cargando datos del form...)</span>
    </button>
    <button (click)="cargarLibros()" class="btn btn-refrescar" [disabled]="cargando">
      {{ cargando ? 'Cargando...' : 'Refrescar Lista' }}
    </button>
  </div>

  <div *ngIf="errorAlModificar" class="mensaje-error global-error">{{ errorAlModificar }}</div>

  <div *ngIf="mostrandoFormulario && (isAdmin$ | async)" class="formulario-libro">
    <h3>{{ nuevoLibro.id ? 'Editar Libro' : 'Nuevo Libro' }}</h3>
    <form (ngSubmit)="onSubmitNuevoLibro(libroForm)" #libroForm="ngForm" novalidate>
      <div class="form-group">
        <label for="titulo">Título:</label>
        <input type="text" id="titulo" name="titulo" [(ngModel)]="nuevoLibro.titulo" required minlength="3" #titulo="ngModel"
               [class.invalid-input]="titulo.invalid && (titulo.dirty || titulo.touched)">
        <div *ngIf="titulo.invalid && (titulo.dirty || titulo.touched)" class="mensaje-error">
          <span *ngIf="titulo.errors?.['required']">El título es requerido.</span>
          <span *ngIf="titulo.errors?.['minlength']">El título debe tener al menos 3 caracteres.</span>
        </div>
      </div>

      <div class="form-group">
        <label for="autor_id">Autor:</label>
        <select id="autor_id" name="autor_id" [(ngModel)]="nuevoLibro.autor_id" required #autor_id="ngModel"
                [class.invalid-input]="autor_id.invalid && (autor_id.dirty || autor_id.touched)">
          <option [ngValue]="null" disabled>Seleccione un autor</option>
          <option *ngFor="let autor of todosLosAutores" [value]="autor.id">
            {{ autor.nombre }}
          </option>
        </select>
        <div *ngIf="autor_id.invalid && (autor_id.dirty || autor_id.touched)" class="mensaje-error">
          <span *ngIf="autor_id.errors?.['required']">El autor es requerido.</span>
        </div>
         </div>

      <div class="form-group">
        <label for="categoria_nombre">Categoría:</label>
        <select id="categoria_nombre"
                name="categoria_nombre"
                [(ngModel)]="nuevoLibro.categoria_nombre"
                #categoria_nombre="ngModel"
                [class.invalid-input]="categoria_nombre.invalid && (categoria_nombre.dirty || categoria_nombre.touched)">
          <option [ngValue]="null" disabled>Seleccione una categoría</option>
          <option *ngFor="let categoria of todasLasCategorias" [value]="categoria.nombre">
            {{ categoria.nombre }}
          </option>
        </select>
      </div>
      <div class="form-actions">
        <button type="submit" [disabled]="libroForm.invalid || cargando || cargandoDependencias" class="btn btn-guardar">
          {{ cargando ? 'Guardando...' : 'Guardar Libro' }}
        </button>
        <button type="button" (click)="toggleFormularioAgregarLibro()" class="btn btn-cancelar-form">
          Cancelar
        </button>
      </div>
    </form>
  </div>

  <hr *ngIf="mostrandoFormulario && (isAdmin$ | async)">

  <div *ngIf="cargando && !libros.length" class="mensaje-info">Cargando libros...</div>
  <div *ngIf="errorAlCargar" class="mensaje-error">{{ errorAlCargar }}</div>
  <div *ngIf="!cargando && !errorAlCargar && libros.length === 0" class="mensaje-info">
    No hay libros disponibles en este momento.
    <span *ngIf="isAdmin$ | async"> ¡Agrega el primero!</span>
  </div>

  <ul *ngIf="!cargando && libros.length > 0" class="libros-grid">
    <li *ngFor="let libro of libros" class="libro-card">
      <div class="libro-info">
        <h3>{{ libro.titulo }}</h3>
        <p><strong>Autor:</strong> {{ libro.autor_nombre }}</p>
        
      </div>
      <div class="libro-actions" *ngIf="isAdmin$ | async">
        <button (click)="solicitarEliminarLibro(libro.id)" class="btn btn-eliminar" [disabled]="cargando">
          Eliminar
        </button>
      </div>
    </li>
  </ul>
</div>